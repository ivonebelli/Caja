<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesti√≥n de Caja</title>
    <link rel="stylesheet" href="..shared/styles.css" />
    <style>
      .caja-container {
        max-width: 900px;
        margin: 0 auto;
      }

      .status-banner {
        padding: 20px 30px;
        border-radius: 16px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        animation: fadeInUp 0.5s ease-out;
      }

      .status-banner.open {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border-left: 6px solid #10b981;
      }

      .status-banner.closed {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-left: 6px solid #ef4444;
      }

      .status-icon {
        font-size: 48px;
      }

      .status-info h3 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .status-info p {
        font-size: 15px;
        opacity: 0.8;
      }

      .status-banner.open h3,
      .status-banner.open p {
        color: #065f46;
      }

      .status-banner.closed h3,
      .status-banner.closed p {
        color: #991b1b;
      }

      .form-section {
        background: white;
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .summary-item {
        padding: 20px;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border-radius: 12px;
        text-align: center;
      }

      .summary-label {
        font-size: 14px;
        color: var(--text-light);
        font-weight: 600;
        margin-bottom: 8px;
      }

      .summary-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary);
      }

      .payment-breakdown {
        margin-top: 20px;
      }

      .payment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f9fafb;
        border-radius: 10px;
        margin-bottom: 10px;
      }

      .payment-method {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: var(--text);
      }

      .payment-amount {
        font-size: 18px;
        font-weight: 700;
        color: var(--success);
      }

      .close-input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }

      .difference-alert {
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
      }

      .difference-alert.positive {
        background: #d1fae5;
        color: #065f46;
      }

      .difference-alert.negative {
        background: #fee2e2;
        color: #991b1b;
      }

      .difference-alert.neutral {
        background: #dbeafe;
        color: #1e40af;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container caja-container">
      <div class="header">
        <h1>üí∞ Gesti√≥n de Caja</h1>
        <button class="back-button" onclick="goBack()">Volver</button>
      </div>

      <div id="statusBanner"></div>

      <div id="openForm" class="form-section" style="display: none">
        <h2 class="section-title">üîì Abrir Caja del D√≠a</h2>
        <form onsubmit="createNetflow(event)">
          <div class="form-group">
            <label class="form-label">Monto Inicial de Caja</label>
            <input
              type="number"
              class="form-input"
              id="initialAmount"
              placeholder="Ej: 5000"
              step="0.01"
              min="0"
              required
            />
          </div>
          <div class="form-group">
            <label class="form-label">Notas al abrir caja (opcional)</label>
            <textarea
              class="form-textarea"
              id="openNotes"
              placeholder="Observaciones sobre la apertura de caja"
              rows="3"
            ></textarea>
          </div>
          <button type="submit" class="btn btn-success" style="width: 100%">
            ‚úÖ Abrir Caja
          </button>
        </form>
      </div>

      <div id="openInfo" style="display: none">
        <div class="form-section">
          <h2 class="section-title">üìä Resumen del D√≠a</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">Caja Inicial</div>
              <div class="summary-value" id="summaryInitial">$0</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Ingresos</div>
              <div class="summary-value" id="summaryNetflow">$0</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Egresos</div>
              <div class="summary-value" id="summaryOutflow">$0</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Esperado en Caja</div>
              <div class="summary-value" id="summaryExpected">$0</div>
            </div>
          </div>

          <div class="payment-breakdown">
            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 15px">
              üí≥ Discriminado por Medio de Pago
            </h3>
            <div id="paymentBreakdown"></div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">üîí Cerrar Caja del D√≠a</h2>
          <form onsubmit="closeNetflow(event)">
            <p style="color: var(--text-light); margin-bottom: 20px">
              Ingresa el monto real que hay en caja para cada medio de pago:
            </p>

            <div class="close-input-group" id="closeInputs"></div>

            <div class="form-group">
              <label class="form-label">Notas de Cierre (opcional)</label>
              <textarea
                class="form-textarea"
                id="closeNotes"
                placeholder="Observaciones sobre el cierre"
                rows="3"
              ></textarea>
            </div>

            <div id="differenceAlert"></div>

            <button
              type="submit"
              class="btn btn-danger"
              style="width: 100%; margin-top: 20px"
            >
              üîí Cerrar Caja y Generar PDF
            </button>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="shared/utils.js"></script>
    <script>
      let cachedData = JSON.parse(
        localStorage.getItem("cachedProfileAndDailyNetflowData")
      );
      console.log(cachedData);

      const paymentMethods = [
        { id: "efectivo", name: "Efectivo", icon: "üíµ" },
        { id: "mercadopago", name: "Mercado Pago", icon: "üí≥" },
        { id: "debito", name: "D√©bito", icon: "üí≥" },
        { id: "credito", name: "Cr√©dito", icon: "üí≥" },
        { id: "transferencia", name: "Transferencia", icon: "üè¶" },
      ];

      async function init() {
        await checkCashStatus();
      }

      async function checkCashStatus() {
        try {
          if (cachedData.netflow_id !== "null") {
            console.log("hola");
            showOpenStatus();
            //updateSummary();
          } else {
            showClosedStatus();
          }
        } catch (error) {
          showClosedStatus();
        }
      }
      function showOpenStatus() {
        const banner = document.getElementById("statusBanner");
        console.log(cachedData.netflow_data.start_time);
        console.log(cachedData.netflow_data.starting_cash);
        console.log(banner);
        console.log("hola");
        banner.className = "status-banner open";
        banner.innerHTML = `
        <div class="status-icon">‚úÖ</div>
        <div class="status-info">
          <h3>Caja Abierta</h3>
          
        </div>
      `;
        //FIXME esta mal entonces crashea la funcion y no se cambia a caja abierta
        // <p>
        //   Inicio: ${formatDateTime(cachedData.netflow_data.start_time)} | Monto
        //   inicial: ${formatCurrency(cachedData.netflowData.starting_cash)}
        // </p>;
        document.getElementById("openForm").style.display = "none";
        document.getElementById("openInfo").style.display = "block";
      }

      function showClosedStatus() {
        const banner = document.getElementById("statusBanner");
        banner.className = "status-banner closed";
        banner.innerHTML = `
        <div class="status-icon">üîí</div>
        <div class="status-info">
          <h3>Caja Cerrada</h3>
          <p>No hay caja abierta para el d√≠a de hoy</p>
        </div>
      `;

        document.getElementById("openForm").style.display = "block";
        document.getElementById("openInfo").style.display = "none";
      }

      function updateSummary() {
        document.getElementById("summaryInitial").textContent = formatCurrency(
          cachedData.netflow_data.starting_cash
        );
        document.getElementById("summarySales").textContent = formatCurrency(
          cachedData.sales_summary.total_amount
        );

        document.getElementById("summaryExpected").textContent = formatCurrency(
          cachedData.sales_summary.total_amount +
            cachedData.netflow_data.starting_cash
        );

        const breakdownHTML = paymentMethods
          .filter((pm) => paymentTotals[pm.id] > 0)
          .map(
            (pm) => `
          <div class="payment-item">
            <div class="payment-method">
              <span>${pm.icon}</span>
              <span>${pm.name}</span>
            </div>
            <div class="payment-amount">${formatCurrency(
              paymentTotals[pm.id]
            )}</div>
          </div>
        `
          )
          .join("");

        document.getElementById("paymentBreakdown").innerHTML =
          breakdownHTML ||
          '<p style="color: var(--text-light);">No hay ventas registradas</p>';

        const closeInputsHTML = paymentMethods
          .map(
            (pm) => `
        <div class="form-group">
          <label class="form-label">${pm.icon} ${pm.name}</label>
          <input
            type="number"
            class="form-input close-input"
            id="close_${pm.id}"
            placeholder="Esperado: ${formatCurrency(paymentTotals[pm.id])}"
            step="0.01"
            min="0"
            value="${paymentTotals[pm.id]}"
          >
        </div>
      `
          )
          .join("");

        document.getElementById("closeInputs").innerHTML = closeInputsHTML;

        // NO agregamos listeners aqu√≠, la delegaci√≥n se encarga
        calculateDifference();
      }

      function calculateDifference() {
        const totalSales = salesData.reduce((sum, o) => sum + o.total, 0);
        const expectedTotal = currentSession.initialAmount + totalSales;

        let actualTotal = 0;
        paymentMethods.forEach((pm) => {
          const input = document.getElementById(`close_${pm.id}`);
          const value = input ? parseFloat(input.value) || 0 : 0;
          actualTotal += value;
        });

        const difference = actualTotal - expectedTotal;
        const alert = document.getElementById("differenceAlert");

        if (Math.abs(difference) < 0.01) {
          alert.className = "difference-alert neutral";
          alert.innerHTML = `<span>‚úÖ</span> <span>La caja est√° cuadrada</span>`;
        } else if (difference > 0) {
          alert.className = "difference-alert positive";
          alert.innerHTML = `<span>üìà</span> <span>Sobrante: ${formatCurrency(
            difference
          )}</span>`;
        } else {
          alert.className = "difference-alert negative";
          alert.innerHTML = `<span>üìâ</span> <span>Faltante: ${formatCurrency(
            Math.abs(difference)
          )}</span>`;
        }
      }

      async function createNetflow(event) {
        event.preventDefault();

        const initialAmount = parseFloat(
          document.getElementById("initialAmount").value
        );
        const notes = document.getElementById("openNotes").value;
        const res = await ipcRenderer.invoke("db:create-netflow", {
          store_id: cachedData.profile.store_id,
          starting_cash: initialAmount,
          opening_description: notes,
        });
        if (res.success === true) {
          showNotification("Caja abierta correctamente", "success");
          netflow_id = res.local_id;
          const res2 = await ipcRenderer.invoke(
            "db:get-profile-and-daily-netflow-data",
            cachedData.profile.local_id
          );
          if (res2.success === true) {
            localStorage.setItem(
              "cachedProfileAndDailyNetflowData",
              JSON.stringify(res2.data)
            );
            cachedData = res2.data;
            console.log(cachedData);
          }
          checkCashStatus();
        } else {
          console.error("‚ùå Error abriendo caja:", res.error);
          showNotification("Error al abrir la caja", "error");
        }
      }
      //TODO: rehacer bien
      async function closeNetflow(event) {
        event.preventDefault();

        if (
          !confirm(
            "¬øEst√°s seguro de cerrar la caja? Se generar√° un PDF autom√°ticamente."
          )
        ) {
          return;
        }

        try {
          await generatePDFReport();

          showNotification(
            "Caja cerrada y PDF generado correctamente",
            "success"
          );
        } catch (error) {
          console.error("=== ERROR EN GENERACI√ìN DE PDF ===", error);
          showNotification(
            "Caja cerrada pero hubo un error al generar el PDF",
            "warning"
          );
        }

        setTimeout(() => {
          window.navApi.navigateTo("/cajero/index.html");
        }, 2500);
      }

      async function generatePDFReport() {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          doc.setFontSize(18);
          doc.setFont(undefined, "bold");
          doc.text("REPORTE DE CIERRE DE CAJA", 105, 20, { align: "center" });

          doc.setFontSize(11);
          doc.setFont(undefined, "normal");
          let y = 35;

          doc.text(`Cajero: ${currentUser.profile.name}`, 20, y);
          y += 7;
          doc.text(`Fecha: ${currentSession.date}`, 20, y);
          y += 7;
          doc.text(
            `Hora de Apertura: ${formatDateTime(currentSession.openedAt)}`,
            20,
            y
          );
          y += 7;
          doc.text(
            `Hora de Cierre: ${formatDateTime(currentSession.closedAt)}`,
            20,
            y
          );
          y += 7;
          doc.text(
            `Caja Inicial: ${formatCurrency(currentSession.initialAmount)}`,
            20,
            y
          );
          y += 12;

          doc.setFontSize(14);
          doc.setFont(undefined, "bold");
          doc.text("DETALLE DE VENTAS", 20, y);
          y += 7;

          const totalSales = salesData.reduce((sum, o) => sum + o.total, 0);

          if (salesData.length > 0) {
            const salesTableData = [];

            salesData.forEach((order) => {
              const paymentMethodText =
                order.paymentMethod === "mixto"
                  ? "Mixto (" +
                    Object.entries(order.paymentDetails || {})
                      .filter(([_, val]) => val > 0)
                      .map(([key, val]) => `${key}: $${val.toFixed(2)}`)
                      .join(", ") +
                    ")"
                  : getPaymentMethodName(order.paymentMethod);

              order.items.forEach((item, itemIndex) => {
                if (itemIndex === 0) {
                  salesTableData.push([
                    order.orderNumber,
                    order.time,
                    order.pin,
                    item.name,
                    item.quantity,
                    `$${item.price.toFixed(2)}`,
                    `$${(item.price * item.quantity).toFixed(2)}`,
                    `$${order.total.toFixed(2)}`,
                    paymentMethodText,
                  ]);
                } else {
                  salesTableData.push([
                    "",
                    "",
                    "",
                    item.name,
                    item.quantity,
                    `$${item.price.toFixed(2)}`,
                    `$${(item.price * item.quantity).toFixed(2)}`,
                    "",
                    "",
                  ]);
                }
              });
            });

            doc.autoTable({
              startY: y,
              head: [
                [
                  "N¬∞ Orden",
                  "Hora",
                  "PIN",
                  "Producto",
                  "Cant.",
                  "Precio U.",
                  "Subtotal",
                  "Total",
                  "Pago",
                ],
              ],
              body: salesTableData,
              theme: "grid",
              styles: { fontSize: 8, cellPadding: 2 },
              headStyles: {
                fillColor: [99, 102, 241],
                textColor: 255,
                fontStyle: "bold",
              },
              columnStyles: {
                0: { cellWidth: 18 },
                1: { cellWidth: 15 },
                2: { cellWidth: 18 },
                3: { cellWidth: 35 },
                4: { cellWidth: 12 },
                5: { cellWidth: 18 },
                6: { cellWidth: 18 },
                7: { cellWidth: 18 },
                8: { cellWidth: 38 },
              },
            });

            y = doc.lastAutoTable.finalY + 10;
          } else {
            doc.setFontSize(10);
            doc.setFont(undefined, "normal");
            doc.text("No hay ventas registradas", 20, y);
            y += 15;
          }

          doc.setFontSize(14);
          doc.setFont(undefined, "bold");
          doc.text("RESUMEN POR MEDIO DE PAGO", 20, y);
          y += 7;

          const paymentTotals = {};
          paymentMethods.forEach((pm) => {
            paymentTotals[pm.id] = {
              expected: salesData
                .filter(
                  (o) =>
                    o.paymentMethod === pm.id ||
                    (o.paymentMethod === "mixto" &&
                      o.paymentDetails &&
                      o.paymentDetails[pm.id] > 0)
                )
                .reduce((sum, o) => {
                  if (o.paymentMethod === "mixto" && o.paymentDetails) {
                    return sum + (o.paymentDetails[pm.id] || 0);
                  }
                  return sum + o.total;
                }, 0),
              actual: currentSession.closedAmounts[pm.id] || 0,
            };
          });

          const paymentTableData = paymentMethods.map((pm) => {
            const expected = paymentTotals[pm.id].expected;
            const actual = paymentTotals[pm.id].actual;
            const difference = actual - expected;

            return [
              pm.name,
              `$${expected.toFixed(2)}`,
              `$${actual.toFixed(2)}`,
              `$${difference.toFixed(2)}`,
            ];
          });

          doc.autoTable({
            startY: y,
            head: [["Medio de Pago", "Esperado", "Real", "Diferencia"]],
            body: paymentTableData,
            theme: "grid",
            styles: { fontSize: 10, cellPadding: 3 },
            headStyles: {
              fillColor: [99, 102, 241],
              textColor: 255,
              fontStyle: "bold",
            },
          });

          y = doc.lastAutoTable.finalY + 10;

          const totalExpected = currentSession.initialAmount + totalSales;
          const totalActual = Object.values(
            currentSession.closedAmounts
          ).reduce((sum, val) => sum + val, 0);
          const totalDifference = totalActual - totalExpected;

          doc.setFontSize(14);
          doc.setFont(undefined, "bold");
          doc.text("TOTALES GENERALES", 20, y);
          y += 7;

          doc.setFontSize(11);
          doc.setFont(undefined, "normal");
          doc.text(`Total Ingresos: ${formatCurrency(totalSales)}`, 20, y);
          y += 7;
          doc.text(
            `Caja Inicial: ${formatCurrency(currentSession.initialAmount)}`,
            20,
            y
          );
          y += 7;
          doc.text(`Total Esperado: ${formatCurrency(totalExpected)}`, 20, y);
          y += 7;
          doc.text(`Total Real: ${formatCurrency(totalActual)}`, 20, y);
          y += 7;

          doc.setFont(undefined, "bold");
          if (totalDifference > 0) {
            doc.setTextColor(16, 185, 129);
          } else if (totalDifference < 0) {
            doc.setTextColor(239, 68, 68);
          } else {
            doc.setTextColor(59, 130, 246);
          }
          doc.text(`Diferencia: ${formatCurrency(totalDifference)}`, 20, y);
          doc.setTextColor(0, 0, 0);
          y += 10;

          doc.setFont(undefined, "normal");
          doc.text(`Cantidad de √ìrdenes: ${salesData.length}`, 20, y);
          y += 10;

          if (currentSession.notes || currentSession.closeNotes) {
            doc.setFontSize(12);
            doc.setFont(undefined, "bold");
            doc.text("NOTAS", 20, y);
            y += 7;

            doc.setFontSize(10);
            doc.setFont(undefined, "normal");
            if (currentSession.notes) {
              doc.text(`Apertura: ${currentSession.notes}`, 20, y, {
                maxWidth: 170,
              });
              y += 7;
            }
            if (currentSession.closeNotes) {
              doc.text(`Cierre: ${currentSession.closeNotes}`, 20, y, {
                maxWidth: 170,
              });
            }
          }

          const now = new Date();
          const dateStr = currentSession.date.replace(/\//g, "-");
          const timeStr = `${now.getHours().toString().padStart(2, "0")}${now
            .getMinutes()
            .toString()
            .padStart(2, "0")}${now.getSeconds().toString().padStart(2, "0")}`;
          const cashierName = currentUser.profile.name.replace(/\s+/g, "_");
          const fileName = `Cierre_Caja_${cashierName}_${dateStr}_${timeStr}.pdf`;

          const pdfBuffer = doc.output("arraybuffer");
          const saved = await saveExcelReport(fileName, pdfBuffer);

          if (saved) {
          } else {
            throw new Error("Failed to save PDF file");
          }
        } catch (error) {
          console.error("‚ùå Error generando reporte PDF:", error);
          throw error;
        }
      }

      function getPaymentMethodName(id) {
        const method = paymentMethods.find((pm) => pm.id === id);
        return method ? method.name : id;
      }

      function goBack() {
        window.navApi.navigateTo(`/cajero/index.html?profile_id=${profile_id}`);
      }

      // DELEGACI√ìN DE EVENTOS para inputs de cierre
      document.addEventListener("input", function (e) {
        if (e.target.classList.contains("close-input")) {
          calculateDifference();
        }
      });

      init();
    </script>
  </body>
</html>
