<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesti√≥n de Caja</title>
    <link rel="stylesheet" href="../shared/styles.css" />
    <style>
      .caja-container {
        max-width: 900px;
        margin: 0 auto;
      }

      .status-banner {
        padding: 20px 30px;
        border-radius: 16px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        animation: fadeInUp 0.5s ease-out;
      }

      .status-banner.open {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border-left: 6px solid #10b981;
      }

      .status-banner.closed {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-left: 6px solid #ef4444;
      }

      .status-icon {
        font-size: 48px;
      }

      .status-info h3 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .status-info p {
        font-size: 15px;
        opacity: 0.8;
      }

      .status-banner.open h3,
      .status-banner.open p {
        color: #065f46;
      }

      .status-banner.closed h3,
      .status-banner.closed p {
        color: #991b1b;
      }

      .form-section {
        background: white;
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .summary-item {
        padding: 20px;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        border-radius: 12px;
        text-align: center;
      }

      .summary-label {
        font-size: 14px;
        color: var(--text-light);
        font-weight: 600;
        margin-bottom: 8px;
      }

      .summary-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary);
      }

      .payment-breakdown {
        margin-top: 20px;
      }

      .payment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f9fafb;
        border-radius: 10px;
        margin-bottom: 10px;
      }

      .payment-method {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: var(--text);
      }

      .payment-amount {
        font-size: 18px;
        font-weight: 700;
        color: var(--success);
      }

      .close-input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }

      .difference-alert {
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
      }

      .difference-alert.positive {
        background: #d1fae5;
        color: #065f46;
      }

      .difference-alert.negative {
        background: #fee2e2;
        color: #991b1b;
      }

      .difference-alert.neutral {
        background: #dbeafe;
        color: #1e40af;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container caja-container">
      <div class="header">
        <h1>üí∞ Gesti√≥n de Caja</h1>
        <button class="back-button" onclick="goBack()">Volver</button>
      </div>

      <div id="statusBanner"></div>

      <div id="openForm" class="form-section" style="display: none">
        <h2 class="section-title">üîì Abrir Caja del D√≠a</h2>
        <form onsubmit="createNetflow(event)">
          <div class="form-group">
            <label class="form-label">Monto Inicial de Caja</label>
            <input
              type="number"
              class="form-input"
              id="initialAmount"
              step="0.01"
              min="0"
              required
              disabled
            />
          </div>
          <div class="form-group">
            <label class="form-label">Notas al abrir caja (opcional)</label>
            <textarea
              class="form-textarea"
              id="openNotes"
              placeholder="Observaciones sobre la apertura de caja"
              rows="3"
            ></textarea>
          </div>
          <button type="submit" class="btn btn-success" style="width: 100%">
            ‚úÖ Abrir Caja
          </button>
        </form>
      </div>

      <div id="openInfo" style="display: none">
        <div class="form-section">
          <h2 class="section-title">üìä Resumen del D√≠a</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">Caja Inicial</div>
              <div
                class="summary-value"
                id="summaryInitial"
                style="color: #010001"
              >
                $0
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Ventas</div>
              <div
                class="summary-value"
                id="summarySales"
                style="color: #28965a"
              >
                $0
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Otros</div>
              <div
                class="summary-value"
                id="summaryOtherInflows"
                style="color: #28965a"
              >
                $0
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Ingresos</div>
              <div
                class="summary-value"
                id="summaryInflow"
                style="color: #28965a"
              >
                $0
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total Egresos</div>
              <div
                class="summary-value"
                id="summaryOutflow"
                style="color: #7b0828"
              >
                $0
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Balance Final</div>
              <div
                class="summary-value"
                id="summaryNetflow"
                style="color: #010001"
              >
                $0
              </div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Esperado en Caja</div>
              <div
                class="summary-value"
                id="summaryExpectedFinalAmount"
                style="color: #010001"
              >
                $0
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">üîí Cerrar Caja del D√≠a</h2>

          <form onsubmit="closeNetflow(event)">
            <p style="color: var(--text-light); margin-bottom: 20px">
              Ingresa el monto real que hay en caja para cada medio de pago:
            </p>

            <div class="close-input-group" id="closeInputs">
              <!-- Placeholder para Efectivo -->
              <div class="form-group">
                <label class="form-label"
                  >üíµ Efectivo (Esperado:
                  <span id="expected-efectivo">$0</span>)</label
                >
                <input
                  type="number"
                  class="form-input close-input"
                  data-method-id="efectivo"
                  data-expected="0"
                  placeholder="Monto contado"
                  step="0.01"
                  required
                />
                <small
                  id="diff-efectivo"
                  style="
                    display: block;
                    margin-top: 5px;
                    font-weight: 600;
                    color: #6b7280;
                  "
                  >Balance: $0.00</small
                >
              </div>

              <!-- Placeholder para Digital -->
              <div class="form-group">
                <label class="form-label"
                  >üí≥ Mercado Pago (Esperado:
                  <span id="expected-mercadopago">$0</span>)</label
                >
                <input
                  type="number"
                  class="form-input close-input"
                  data-method-id="mercadopago"
                  data-expected="0"
                  placeholder="Monto reportado"
                  step="0.01"
                  required
                />
                <small
                  id="diff-mercadopago"
                  style="
                    display: block;
                    margin-top: 5px;
                    font-weight: 600;
                    color: #6b7280;
                  "
                  >Balance: $0.00</small
                >
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Notas de Cierre (opcional)</label>
              <textarea
                class="form-textarea"
                id="closeNotes"
                placeholder="Observaciones sobre el cierre"
                rows="3"
              ></textarea>
            </div>

            <div id="differenceAlert">
              <div class="difference-alert neutral">
                <span>‚öñÔ∏è</span>
                <span>Diferencia Total: En espera de conteo.</span>
              </div>
            </div>

            <button
              type="submit"
              class="btn btn-danger"
              style="width: 100%; margin-top: 20px"
            >
              üîí Cerrar Caja
            </button>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="../shared/utils.js"></script>
    <script>
      const paymentMethods = [
        { id: "efectivo", name: "Efectivo", icon: "üíµ" },
        { id: "mercadopago", name: "Mercado Pago", icon: "üí≥" },
        { id: "debito", name: "D√©bito", icon: "üí≥" },
        { id: "credito", name: "Cr√©dito", icon: "üí≥" },
        { id: "transferencia", name: "Transferencia", icon: "üè¶" },
      ];

      async function init() {
        await checkCashStatus();
      }

      async function checkCashStatus() {
        const storedValue = await window.storageApi.getItem(
          "profileAndNetflowData"
        );

        let currentProfile = storedValue;
        console.log(currentProfile);
        const initialAmount = document.getElementById("initialAmount");

        initialAmount.value = currentProfile.last_netflow_final_amount;
        try {
          if (currentProfile.netflow_id !== null) {
            await showOpenStatus();
            //await updateSummary();
          } else {
            showClosedStatus();
          }
        } catch (error) {
          showClosedStatus();
        }
      }
      async function showOpenStatus() {
        const storedValue = await window.storageApi.getItem(
          "profileAndNetflowData"
        );
        let currentProfile = storedValue;
        const banner = document.getElementById("statusBanner");

        banner.className = "status-banner open";
        banner.innerHTML = `
        <div class="status-icon">‚úÖ</div>
        <div class="status-info">
          <h3>Caja Abierta</h3>
           <p>
          Inicio: ${formatDateTime(currentProfile.netflow_data.initial_time)}

        </p>

        </div>`;

        // `;
        document.getElementById("openForm").style.display = "none";
        document.getElementById("openInfo").style.display = "block";
      }

      function showClosedStatus() {
        const banner = document.getElementById("statusBanner");
        banner.className = "status-banner closed";
        banner.innerHTML = `
        <div class="status-icon">üîí</div>
        <div class="status-info">
          <h3>Caja Cerrada</h3>
          <p>No hay caja abierta para el d√≠a de hoy</p>
        </div>
      `;

        document.getElementById("openForm").style.display = "block";
        document.getElementById("openInfo").style.display = "none";
      }

      async function updateSummary() {
        const currentProfile = await window.storageApi.getItem(
          "profileAndNetflowData"
        );
        document.getElementById("summaryInitial").textContent = formatCurrency(
          currentProfile.netflow_data.initial_amount
        );
        document.getElementById("summarySales").textContent = formatCurrency(
          currentProfile.netflow_data.sales_summary.total
        );
        document.getElementById("summaryOtherInflows").textContent =
          formatCurrency(currentProfile.netflow_data.inflow_total);
        document.getElementById("sumamaryInflow").textContent = formatCurrency(
          currentProfile.netflow_data.sales_summary.total +
            currentProfile.netflow_data.inflow_total
        );
        document.getElementById("sumamaryOutflow").textContent = formatCurrency(
          currentProfile.netflow_data.expense_total
        );

        document.getElementById("sumamaryOutflow").textContent = formatCurrency(
          currentProfile.netflow_data.sales_summary.total +
            currentProfile.netflow_data.inflow_total -
            currentProfile.netflow_data.expense_total
        );
        document.getElementById("summaryExpectedFinalAmount").textContent =
          formatCurrency(
            currentProfile.netflow_data.initialAmount +
              currentProfile.netflow_data.sales_summary.total +
              currentProfile.netflow_data.inflow_total -
              currentProfile.netflow_data.expense_total
          );
      }

      async function createNetflow(event) {
        event.preventDefault();

        const initialNotes = document.getElementById("openNotes").value;
        const storedValue = await window.storageApi.getItem(
          "profileAndNetflowData"
        );
        let currentProfile = storedValue;
        const res = await window.dbApi.createNetflow({
          store_id: currentProfile.profile.store_id,
          opening_description: initialNotes,
        });
        if (res.success === true) {
          showNotification("Caja abierta correctamente", "success");
          netflow_id = res.local_id;
          const res2 = await window.dbApi.getProfileAndDailyNetflowData(
            currentProfile.profile.local_id
          );
          if (res2.success === true) {
            window.storageApi.setItem("profileAndNetflowData", res2.data);
            currentProfile = res2.data;
          }
          await checkCashStatus();
        } else {
          console.error("‚ùå Error abriendo caja:", res.error);
          showNotification("Error al abrir la caja", "error");
        }
      }

      async function closeNetflow(event) {
        event.preventDefault();

        if (!confirm("¬øEst√°s seguro de cerrar la caja?")) {
          return;
        }

        showNotification("Caja cerrada ", "success");

        const balanceFinal =
          currentProfile.netflow_data.initialAmount +
          currentProfile.netflow_data.sales_summary.total +
          currentProfile.netflow_data.inflow_total -
          currentProfile.netflow_data.expense_total;

        const finalNotes = document.getElementById("closeNotes").value;

        await window.dbApi.closeNetflow(balanceFinal, finalNotes);
        setTimeout(() => {
          window.navApi.navigateTo("/cajero/index.html");
        }, 2500);
      }

      function getPaymentMethodName(id) {
        const method = paymentMethods.find((pm) => pm.id === id);
        return method ? method.name : id;
      }

      function goBack() {
        window.navApi.navigateTo(`/cajero/index.html`);
      }

      // DELEGACI√ìN DE EVENTOS para inputs de cierre
      document.addEventListener("input", function (e) {
        if (e.target.classList.contains("close-input")) {
          calculateDifference();
        }
      });

      init();
    </script>
  </body>
</html>
